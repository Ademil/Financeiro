<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APavan_Finanças Pro - Gestão Local</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        .view-content { display: none; }
        .view-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center transition-opacity duration-500 pointer-events-none opacity-0">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-100 border-t-blue-600"></div>
            <p class="text-sm font-medium text-slate-500">A carregar...</p>
        </div>
    </div>

    <div class="flex min-h-screen relative">
        <!-- Sidebar -->
        <aside class="hidden lg:flex flex-col fixed left-0 top-0 h-full w-72 bg-white border-r border-slate-200 p-8 z-50">
            <div class="flex items-center gap-3 mb-12">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                    <i class="fas fa-vault text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-none">APavan_FinançasPro</h1>
                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Modo Local</span>
                </div>
            </div>
            
            <nav class="space-y-1">
                <button onclick="changeView('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all text-slate-500 hover:bg-slate-50 font-medium" data-view="dashboard">
                    <i class="fas fa-chart-pie w-5"></i> Dashboard
                </button>
                <button onclick="changeView('list')" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all text-slate-500 hover:bg-slate-50 font-medium" data-view="list">
                    <i class="fas fa-receipt w-5"></i> Extrato Mensal
                </button>
                <button onclick="changeView('calculator')" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all text-slate-500 hover:bg-slate-50 font-medium" data-view="calculator">
                    <i class="fas fa-calculator w-5"></i> Calculadora
                </button>
                <div class="pt-4 pb-2">
                    <button onclick="openForm()" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl bg-blue-600 text-white shadow-md hover:bg-blue-700 transition-all font-semibold">
                        <i class="fas fa-plus-circle"></i> Novo Lançamento
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-72 p-4 md:p-8 lg:p-12 pb-28">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <h2 id="view-title" class="text-3xl font-extrabold tracking-tight">Dashboard</h2>
                    <p id="view-subtitle" class="text-slate-500 font-medium">Controlo financeiro offline.</p>
                </div>

                <div id="calendar-controls" class="flex items-center bg-white p-1.5 rounded-2xl border border-slate-200 shadow-sm">
                    <button onclick="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center hover:bg-slate-50 rounded-xl text-slate-400 transition-colors">
                        <i class="fas fa-chevron-left text-sm"></i>
                    </button>
                    <div class="px-6 text-center min-w-[160px]">
                        <span id="label-month" class="block font-bold text-sm text-slate-900">...</span>
                        <span id="label-year" class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">2024</span>
                    </div>
                    <button onclick="changeMonth(1)" class="w-10 h-10 flex items-center justify-center hover:bg-slate-50 rounded-xl text-slate-400 transition-colors">
                        <i class="fas fa-chevron-right text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard" class="view-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">Entradas</span>
                        <h3 id="dash-receitas" class="text-2xl font-bold text-emerald-600 tracking-tight">R$ 0,00</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">Saídas</span>
                        <h3 id="dash-despesas" class="text-2xl font-bold text-rose-600 tracking-tight">R$ 0,00</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">A Pagar</span>
                        <h3 id="dash-pendente" class="text-2xl font-bold text-amber-600 tracking-tight">R$ 0,00</h3>
                    </div>
                    <div class="bg-slate-900 p-6 rounded-[2rem] text-white shadow-xl shadow-slate-200">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">Saldo Geral</span>
                        <h3 id="dash-saldo" class="text-2xl font-bold">R$ 0,00</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white rounded-[2rem] border border-slate-200 p-8 shadow-sm">
                        <h4 class="font-bold flex items-center gap-2 mb-8 text-slate-800"><i class="fas fa-chart-line text-blue-500"></i> Gastos por Categoria</h4>
                        <div id="cat-distribution" class="grid grid-cols-1 sm:grid-cols-2 gap-x-12 gap-y-6"></div>
                    </div>
                    <div class="bg-white rounded-[2rem] border border-slate-200 p-8 shadow-sm">
                        <h4 class="font-bold flex items-center gap-2 mb-6 text-slate-800"><i class="fas fa-clock text-amber-500"></i> Próximos Vencimentos</h4>
                        <div id="upcoming-list" class="space-y-4"></div>
                    </div>
                </div>
            </section>

            <!-- VIEW: LIST -->
            <section id="view-list" class="view-content">
                <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[700px]">
                            <thead>
                                <tr class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-50">
                                    <th class="px-6 py-5">Status</th>
                                    <th class="px-6 py-5">Nome</th>
                                    <th class="px-6 py-5">Data</th>
                                    <th class="px-6 py-5">Valor</th>
                                    <th class="px-6 py-5 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="text-sm font-medium text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: CALCULATOR -->
            <section id="view-calculator" class="view-content">
                <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm p-8 md:p-12 max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-3">Valor Inicial</label>
                            <input type="number" id="calc-p" value="1000" class="w-full px-4 py-4 bg-slate-50 rounded-2xl outline-none font-bold text-lg">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-3">Taxa (%)</label>
                            <input type="number" id="calc-i" value="1" class="w-full px-4 py-4 bg-slate-50 rounded-2xl outline-none font-bold text-lg">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-3">Meses</label>
                            <input type="number" id="calc-n" value="12" class="w-full px-4 py-4 bg-slate-50 rounded-2xl outline-none font-bold text-lg">
                        </div>
                    </div>
                    <div class="p-8 bg-blue-50 rounded-[2rem] text-center">
                        <span class="block text-[10px] font-bold text-blue-400 uppercase mb-1">Montante Final</span>
                        <h5 id="res-total" class="text-4xl font-extrabold text-blue-600">R$ 0,00</h5>
                    </div>
                </div>
            </section>

            <!-- VIEW: FORM -->
            <section id="view-form" class="view-content">
                <div class="max-w-2xl mx-auto bg-white rounded-[2.5rem] border border-slate-200 shadow-sm p-8 md:p-12">
                    <h4 id="form-title" class="text-2xl font-bold mb-8 text-center">Novo Lançamento</h4>
                    <form id="finance-form" class="space-y-6">
                        <input type="hidden" id="edit-id">
                        <div class="flex p-1 bg-slate-100 rounded-xl mb-6">
                            <button type="button" onclick="setFormType('despesa')" id="ft-des" class="flex-1 py-2 font-bold rounded-lg bg-white shadow-sm text-rose-600">Despesa</button>
                            <button type="button" onclick="setFormType('receita')" id="ft-rec" class="flex-1 py-2 font-bold rounded-lg text-slate-400">Receita</button>
                        </div>
                        <input type="hidden" id="form-type-val" value="despesa">
                        
                        <input type="text" id="form-name" placeholder="Nome do lançamento" required class="w-full px-5 py-4 bg-slate-50 rounded-2xl outline-none">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" step="0.01" id="form-value" placeholder="Valor R$" required class="w-full px-5 py-4 bg-slate-50 rounded-2xl outline-none font-bold">
                            <input type="date" id="form-date" required class="w-full px-5 py-4 bg-slate-50 rounded-2xl outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <select id="form-cat" class="w-full px-5 py-4 bg-slate-50 rounded-2xl outline-none">
                                <option value="fixa">Conta Fixa</option>
                                <option value="variável">Variável</option>
                                <option value="lazer">Lazer</option>
                                <option value="extra">Outros</option>
                            </select>
                            <select id="form-method" class="w-full px-5 py-4 bg-slate-50 rounded-2xl outline-none">
                                <option value="PIX">PIX</option>
                                <option value="Cartão">Cartão</option>
                                <option value="Dinheiro">Dinheiro</option>
                            </select>
                        </div>
                        <div class="flex gap-4 pt-6">
                            <button type="button" onclick="changeView('dashboard')" class="flex-1 py-4 font-bold text-slate-400">Cancelar</button>
                            <button type="submit" class="flex-1 py-4 bg-blue-600 text-white font-extrabold rounded-2xl shadow-lg">Gravar</button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script>
        // ESTADO LOCAL (Substitui o Firebase por LocalStorage)
        const state = {
            registros: JSON.parse(localStorage.getItem('financas_pro_data')) || [],
            month: new Date().getMonth(),
            year: new Date().getFullYear(),
            months: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]
        };

        const saveToLocal = () => {
            localStorage.setItem('financas_pro_data', JSON.stringify(state.registros));
            renderAll();
        };

        const formatBRL = (v) => Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        function renderAll() {
            updateLabels();
            const filtered = state.registros.filter(r => {
                const d = new Date(r.data);
                return d.getUTCMonth() === state.month && d.getUTCFullYear() === state.year;
            }).sort((a, b) => new Date(a.data) - new Date(b.data));

            renderDashboard(filtered);
            renderList(filtered);
            doCalc();
        }

        function updateLabels() {
            document.getElementById('label-month').innerText = state.months[state.month];
            document.getElementById('label-year').innerText = state.year;
        }

        function renderDashboard(data) {
            const ent = data.filter(r => r.tipo === 'receita').reduce((a, b) => a + b.valor, 0);
            const sai = data.filter(r => r.tipo === 'despesa').reduce((a, b) => a + b.valor, 0);
            const pend = data.filter(r => r.tipo === 'despesa' && !r.pago).reduce((a, b) => a + b.valor, 0);
            
            document.getElementById('dash-receitas').innerText = formatBRL(ent);
            document.getElementById('dash-despesas').innerText = formatBRL(sai);
            document.getElementById('dash-pendente').innerText = formatBRL(pend);
            document.getElementById('dash-saldo').innerText = formatBRL(ent - sai);

            const catDiv = document.getElementById('cat-distribution');
            catDiv.innerHTML = '';
            ['fixa', 'variável', 'lazer', 'extra'].forEach(c => {
                const total = data.filter(r => r.categoria === c).reduce((a, b) => a + b.valor, 0);
                if(total > 0) {
                    const perc = (total / (sai || 1)) * 100;
                    catDiv.innerHTML += `<div><p class='text-xs uppercase font-bold text-slate-400'>${c}</p><p class='font-bold'>${formatBRL(total)}</p><div class='h-1.5 bg-slate-100 rounded-full mt-1'><div class='h-full bg-blue-500 rounded-full' style='width:${perc}%'></div></div></div>`;
                }
            });

            const upDiv = document.getElementById('upcoming-list');
            const pending = data.filter(r => r.tipo === 'despesa' && !r.pago).slice(0, 4);
            upDiv.innerHTML = pending.length ? '' : '<p class="text-slate-400 text-sm">Nada pendente.</p>';
            pending.forEach(r => {
                upDiv.innerHTML += `<div class='flex justify-between bg-slate-50 p-3 rounded-xl border border-slate-100'><p class='text-xs font-bold'>${r.nome}</p><span class='text-xs text-rose-500 font-bold'>-${formatBRL(r.valor)}</span></div>`;
            });
        }

        function renderList(data) {
            const body = document.getElementById('table-body');
            body.innerHTML = data.length ? '' : '<tr><td colspan="5" class="p-10 text-center text-slate-400">Sem dados este mês.</td></tr>';
            data.forEach(r => {
                body.innerHTML += `
                <tr class="border-b border-slate-50">
                    <td class="px-6 py-4"><button onclick="togglePago('${r.id}')" class="${r.pago ? 'text-emerald-500' : 'text-slate-300'}"><i class="fas fa-check-circle text-lg"></i></button></td>
                    <td class="px-6 py-4 font-bold text-slate-800">${r.nome}</td>
                    <td class="px-6 py-4 text-xs">${new Date(r.data).toLocaleDateString('pt-BR')}</td>
                    <td class="px-6 py-4 font-bold ${r.tipo === 'receita' ? 'text-emerald-500' : 'text-rose-500'}">${formatBRL(r.valor)}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editReg('${r.id}')" class="text-slate-400 hover:text-blue-500 mx-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteReg('${r.id}')" class="text-slate-400 hover:text-rose-500"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function doCalc() {
            const P = parseFloat(document.getElementById('calc-p').value) || 0;
            const i = (parseFloat(document.getElementById('calc-i').value) || 0) / 100;
            const n = parseFloat(document.getElementById('calc-n').value) || 0;
            document.getElementById('res-total').innerText = formatBRL(P * Math.pow((1 + i), n));
        }

        window.changeView = (v) => {
            document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active');
            document.getElementById('view-title').innerText = v.charAt(0).toUpperCase() + v.slice(1);
            document.getElementById('calendar-controls').style.display = (v === 'calculator' || v === 'form') ? 'none' : 'flex';
        };

        window.setFormType = (t) => {
            document.getElementById('form-type-val').value = t;
            document.getElementById('ft-des').className = `flex-1 py-2 font-bold rounded-lg ${t === 'despesa' ? 'bg-white shadow-sm text-rose-600' : 'text-slate-400'}`;
            document.getElementById('ft-rec').className = `flex-1 py-2 font-bold rounded-lg ${t === 'receita' ? 'bg-white shadow-sm text-emerald-600' : 'text-slate-400'}`;
        };

        window.changeMonth = (d) => {
            state.month += d;
            if(state.month > 11) { state.month = 0; state.year++; }
            if(state.month < 0) { state.month = 11; state.year--; }
            renderAll();
        };

        window.openForm = () => {
            document.getElementById('finance-form').reset();
            document.getElementById('edit-id').value = '';
            changeView('form');
        };

        window.togglePago = (id) => {
            const r = state.registros.find(x => x.id == id);
            if(r) r.pago = !r.pago;
            saveToLocal();
        };

        window.deleteReg = (id) => {
            if(confirm("Apagar registo?")) {
                state.registros = state.registros.filter(r => r.id != id);
                saveToLocal();
            }
        };

        window.editReg = (id) => {
            const r = state.registros.find(x => x.id == id);
            document.getElementById('edit-id').value = r.id;
            document.getElementById('form-name').value = r.nome;
            document.getElementById('form-value').value = r.valor;
            document.getElementById('form-date').value = r.data;
            setFormType(r.tipo);
            changeView('form');
        };

        document.getElementById('finance-form').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                id: id || Date.now(),
                nome: document.getElementById('form-name').value,
                valor: parseFloat(document.getElementById('form-value').value),
                data: document.getElementById('form-date').value,
                tipo: document.getElementById('form-type-val').value,
                categoria: document.getElementById('form-cat').value,
                meio: document.getElementById('form-method').value,
                pago: id ? state.registros.find(x => x.id == id).pago : false
            };

            if(id) {
                const idx = state.registros.findIndex(x => x.id == id);
                state.registros[idx] = data;
            } else {
                state.registros.push(data);
            }
            saveToLocal();
            changeView('dashboard');
        };

        ['calc-p', 'calc-i', 'calc-n'].forEach(id => document.getElementById(id).addEventListener('input', doCalc));
        
        // Iniciar
        renderAll();
    </script>
</body>
</html>